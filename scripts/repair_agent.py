import os
import sys
import json
import base64
import urllib.request

TOKEN = os.environ.get("GITHUB_TOKEN")
ORG = "ai-ulu"

def github_request(url, method="GET", data=None):
    headers = {"Authorization": f"token {TOKEN}", "Accept": "application/vnd.github.v3+json"}
    req = urllib.request.Request(url, headers=headers, method=method)
    if data:
        req.add_header("Content-Type", "application/json")
        data = json.dumps(data).encode()
    try:
        with urllib.request.urlopen(req, data=data) as res:
            return json.loads(res.read().decode()), res.status
    except Exception as e:
        print(f"Error: {e}")
        return None, 0

def autonomous_heal(repo_name):
    print(f"ðŸ¤– Agentic Repair initiated for {repo_name}...")
    
    path = "tests/chaos_test.js"
    url = f"https://api.github.com/repos/{ORG}/{repo_name}/contents/{path}"
    
    res_data, status = github_request(url)
    if status == 200:
        sha = res_data["sha"]
        print(f"ðŸ” Found chaos file. Deleting to restore order...")
        
        branch_name = "fix/chaos-recovery-" + str(random.randint(1000, 9999)) if 'random' in locals() else "fix/chaos-recovery"
        import random
        branch_name = "fix/chaos-recovery-" + str(random.randint(1000, 9999))

        # Get default branch
        repo_info, _ = github_request(f"https://api.github.com/repos/{ORG}/{repo_name}")
        default_branch = repo_info.get("default_branch", "main")
        
        # Get main SHA
        ref_info, _ = github_request(f"https://api.github.com/repos/{ORG}/{repo_name}/git/ref/heads/{default_branch}")
        main_sha = ref_info["object"]["sha"]
        
        # Create branch
        github_request(f"https://api.github.com/repos/{ORG}/{repo_name}/git/refs", method="POST", data={"ref": f"refs/heads/{branch_name}", "sha": main_sha})
        
        # Delete file
        github_request(url, method="DELETE", data={
            "message": "ðŸ› ï¸ Autonomous Repair: Removing chaos injection",
            "sha": sha,
            "branch": branch_name
        })
        
        # Open PR
        pr_data, status = github_request(f"https://api.github.com/repos/{ORG}/{repo_name}/pulls", method="POST", data={
            "title": "ðŸ›¡ï¸ Autonomous Self-Healing: Chaos Recovery",
            "head": branch_name,
            "base": default_branch,
            "body": "This Pull Request was automatically generated by the ai-ulu Repair Agent to resolve a detected chaos injection."
        })
        
        if status == 201:
            print(f"âœ… Recovery PR opened: {pr_data['html_url']}")
        else:
            print(f"âŒ Failed to open PR")
    else:
        print("ðŸ¤· No chaos file found.")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        autonomous_heal(sys.argv[1])
    else:
        print("Usage: python repair_agent.py <repo_name>")
