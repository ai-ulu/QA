import os
import sys
import requests
import base64

TOKEN = os.environ.get("GITHUB_TOKEN")
ORG = "ai-ulu"
headers = {"Authorization": f"token {TOKEN}", "Accept": "application/vnd.github.v3+json"}

def autonomous_heal(repo_name):
    print(f"ðŸ¤– Agentic Repair initiated for {repo_name}...")
    
    # 1. Look for the chaos test file
    path = "tests/chaos_test.js"
    url = f"https://api.github.com/repos/{ORG}/{repo_name}/contents/{path}"
    
    res = requests.get(url, headers=headers)
    if res.status_code == 200:
        sha = res.json()["sha"]
        print(f"ðŸ” Found chaos file at {path}. Deleting to restore order...")
        
        # 2. Create a fix branch
        branch_name = "fix/chaos-monkey-recovery"
        ref_url = f"https://api.github.com/repos/{ORG}/{repo_name}/git/refs"
        
        # Get main SHA
        main_res = requests.get(f"https://api.github.com/repos/{ORG}/{repo_name}/git/ref/heads/main", headers=headers)
        if main_res.status_code != 200:
            main_res = requests.get(f"https://api.github.com/repos/{ORG}/{repo_name}/git/ref/heads/master", headers=headers)
        
        main_sha = main_res.json()["object"]["sha"]
        
        # Create branch
        requests.post(ref_url, headers=headers, json={"ref": f"refs/heads/{branch_name}", "sha": main_sha})
        
        # 3. Delete the file in the new branch
        requests.delete(url, headers=headers, json={
            "message": "ðŸ› ï¸ Autonomous Repair: Removing chaos injection",
            "sha": sha,
            "branch": branch_name
        })
        
        # 4. Open PR
        pr_url = f"https://api.github.com/repos/{ORG}/{repo_name}/pulls"
        pr_res = requests.post(pr_url, headers=headers, json={
            "title": "ðŸ›¡ï¸ Autonomous Self-Healing: Chaos Recovery",
            "head": branch_name,
            "base": "main", # Or master
            "body": "This Pull Request was automatically generated by the ai-ulu Repair Agent to resolve a detected chaos injection."
        })
        
        if pr_res.status_code == 201:
            print(f"âœ… Recovery PR opened: {pr_res.json()['html_url']}")
            update_dashboard(repo_name, "Healed")
        else:
            print(f"âŒ Failed to open PR: {pr_res.text}")
    else:
        print("ðŸ¤· No chaos file found. Nothing to repair.")

def update_dashboard(repo_name, action):
    # This would ideally update the dashboard log
    print(f"ðŸ“ Logging action to War Room: {repo_name} -> {action}")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        autonomous_heal(sys.argv[1])
    else:
        print("Usage: python repair_agent.py <repo_name>")
